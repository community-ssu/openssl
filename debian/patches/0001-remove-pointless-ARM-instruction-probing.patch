#! /bin/sh /usr/share/dpatch/dpatch-run
## 0001-remove-pointless-ARM-instruction-probing.patch by  <eike@sf-mail.de>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: remove pointless ARM instruction probing
##
## From 4fc945f1fbcf815e9cb07cc9e3d1a7e411fcd0da Mon Sep 17 00:00:00 2001
## From: Rolf Eike Beer <eike@sf-mail.de>
## Date: Fri, 30 Jun 2017 22:04:54 +0200
## Subject: [PATCH] remove pointless ARM instruction probing
##
## These instructions do not exist on the N900, so do not probe for them on every
## start. This makes life easier when running the program in debugger, as otherwise
## one would get 5 traps on startup before the actual program starts running.
## ---
##  crypto/armcap.c     | 24 ------------------------
##  crypto/armv4cpuid.S | 34 ----------------------------------
##  2 files changed, 58 deletions(-)

@DPATCH@

diff --git a/crypto/armcap.c b/crypto/armcap.c
index 356fa1528..84b1bca28 100644
--- a/crypto/armcap.c
+++ b/crypto/armcap.c
@@ -32,17 +32,9 @@ static void ill_handler(int sig)
  * ARM compilers support inline assembler...
  */
 void _armv7_neon_probe(void);
-void _armv8_aes_probe(void);
-void _armv8_sha1_probe(void);
-void _armv8_sha256_probe(void);
-void _armv8_pmull_probe(void);
-unsigned long _armv7_tick(void);
 
 unsigned long OPENSSL_rdtsc(void)
 {
-    if (OPENSSL_armcap_P & ARMV7_TICK)
-        return _armv7_tick();
-    else
         return 0;
 }
 
@@ -137,25 +129,6 @@ void OPENSSL_cpuid_setup(void)
     } else if (sigsetjmp(ill_jmp, 1) == 0) {
         _armv7_neon_probe();
         OPENSSL_armcap_P |= ARMV7_NEON;
-        if (sigsetjmp(ill_jmp, 1) == 0) {
-            _armv8_pmull_probe();
-            OPENSSL_armcap_P |= ARMV8_PMULL | ARMV8_AES;
-        } else if (sigsetjmp(ill_jmp, 1) == 0) {
-            _armv8_aes_probe();
-            OPENSSL_armcap_P |= ARMV8_AES;
-        }
-        if (sigsetjmp(ill_jmp, 1) == 0) {
-            _armv8_sha1_probe();
-            OPENSSL_armcap_P |= ARMV8_SHA1;
-        }
-        if (sigsetjmp(ill_jmp, 1) == 0) {
-            _armv8_sha256_probe();
-            OPENSSL_armcap_P |= ARMV8_SHA256;
-        }
-    }
-    if (sigsetjmp(ill_jmp, 1) == 0) {
-        _armv7_tick();
-        OPENSSL_armcap_P |= ARMV7_TICK;
     }
 
     sigaction(SIGILL, &ill_oact, NULL);
diff --git a/crypto/armv4cpuid.S b/crypto/armv4cpuid.S
index 65010ae4fe..0c05ce5097 100644
--- a/crypto/armv4cpuid.S
+++ b/crypto/armv4cpuid.S
@@ -87,40 +87,6 @@ _armv7_neon_probe:
 	vorr	q0,q0,q0
 	bx	lr
 .size	_armv7_neon_probe,.-_armv7_neon_probe
-
-.global	_armv7_tick
-.type	_armv7_tick,%function
-_armv7_tick:
-	mrrc	p15,1,r0,r1,c14		@ CNTVCT
-	bx	lr
-.size	_armv7_tick,.-_armv7_tick
-
-.global	_armv8_aes_probe
-.type	_armv8_aes_probe,%function
-_armv8_aes_probe:
-	.byte	0x00,0x03,0xb0,0xf3	@ aese.8	q0,q0
-	bx	lr
-.size	_armv8_aes_probe,.-_armv8_aes_probe
-
-.global	_armv8_sha1_probe
-.type	_armv8_sha1_probe,%function
-_armv8_sha1_probe:
-	.byte	0x40,0x0c,0x00,0xf2	@ sha1c.32	q0,q0,q0
-	bx	lr
-.size	_armv8_sha1_probe,.-_armv8_sha1_probe
-
-.global	_armv8_sha256_probe
-.type	_armv8_sha256_probe,%function
-_armv8_sha256_probe:
-	.byte	0x40,0x0c,0x00,0xf3	@ sha256h.32	q0,q0,q0
-	bx	lr
-.size	_armv8_sha256_probe,.-_armv8_sha256_probe
-.global	_armv8_pmull_probe
-.type	_armv8_pmull_probe,%function
-_armv8_pmull_probe:
-	.byte	0x00,0x0e,0xa0,0xf2	@ vmull.p64	q0,d0,d0
-	bx	lr
-.size	_armv8_pmull_probe,.-_armv8_pmull_probe
 #endif
 
 .global	OPENSSL_wipe_cpu
-- 
2.13.1

